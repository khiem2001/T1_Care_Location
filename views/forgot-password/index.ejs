<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head', { title: 'Quên mật khẩu' }) %>
  </head>
  <body>
    <div
      class="w-screen h-screen flex items-center justify-end"
      style="
        background-image: url('/images/bg-auth.jpg');
        background-size: cover;
        background-position: center;
      "
    >
      <div class="md:w-1/2 w-full flex items-center justify-center px-5">
        <div class="w-full max-w-lg p-8 bg-white rounded-2xl shadow-lg">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Quên mật khẩu</h2>
            <p class="text-gray-500 text-sm">
              Làm theo từng bước để đặt lại mật khẩu
            </p>
          </div>

          <form class="space-y-5" id="step-1">
            <div>
              <label
                for="phone"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Số điện thoại</label
              >
              <input
                type="text"
                id="phone"
                name="phone"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-purple-600 text-white py-2 rounded-xl hover:bg-purple-700"
            >
              Gửi mã OTP
            </button>
          </form>

          <form class="space-y-5 hidden mt-6" id="step-2">
            <input type="hidden" name="phone" id="otp-phone" />
            <div>
              <label
                for="otp"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Nhập mã OTP</label
              >
              <input
                type="text"
                id="otp"
                name="otp"
                maxlength="6"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-purple-600 text-white py-2 rounded-xl hover:bg-purple-700"
            >
              Xác nhận OTP
            </button>
          </form>

          <form class="space-y-5 hidden mt-6" id="step-3">
            <input type="hidden" name="phone" id="reset-phone" />
            <div>
              <label
                for="newPassword"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Mật khẩu mới</label
              >
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
            <div>
              <label
                for="confirmPassword"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Xác nhận mật khẩu</label
              >
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-purple-600 text-white py-2 rounded-xl hover:bg-purple-700"
            >
              Đặt lại mật khẩu
            </button>
          </form>

          <div class="text-center mt-6">
            <a href="/login" class="text-sm text-purple-600 hover:underline"
              >Quay lại đăng nhập</a
            >
          </div>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
      const formStep1 = document.getElementById('step-1');
      const formStep2 = document.getElementById('step-2');
      const formStep3 = document.getElementById('step-3');
      const otpPhone = document.getElementById('otp-phone');
      const resetPhone = document.getElementById('reset-phone');

      const showAlert = (message) => {
        toastr.error(message);
      };

      // Bước 1: Gửi OTP
      formStep1.addEventListener('submit', async function (e) {
        e.preventDefault();
        const phone = document.getElementById('phone').value;

        try {
          const res = await fetch('/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone }),
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            return showAlert(data.message || 'Gửi OTP thất bại!');
          }

          toastr.success(data.message);
          otpPhone.value = phone;
          resetPhone.value = phone;

          formStep1.classList.add('hidden');
          formStep2.classList.remove('hidden');
        } catch (error) {
          console.error(error);
          showAlert('Có lỗi xảy ra khi gửi OTP.');
        }
      });

      // Bước 2: Xác nhận OTP
      formStep2.addEventListener('submit', async function (e) {
        e.preventDefault();
        const phone = otpPhone.value;
        const otp = document.getElementById('otp').value;

        try {
          const res = await fetch('/confirm-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, otp }),
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            return showAlert(data.message || 'Xác nhận OTP thất bại!');
          }

          toastr.success(data.message);
          formStep2.classList.add('hidden');
          formStep3.classList.remove('hidden');
        } catch (error) {
          console.error(error);
          showAlert('Có lỗi xảy ra khi xác nhận OTP.');
        }
      });

      // Bước 3: Đổi mật khẩu
      formStep3.addEventListener('submit', async function (e) {
        e.preventDefault();
        const phone = resetPhone.value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword =
          document.getElementById('confirmPassword').value;

        try {
          const res = await fetch('/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, newPassword, confirmPassword }),
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            return showAlert(data.message || 'Đổi mật khẩu thất bại!');
          }

          toastr.success(data.message);
          window.location.href = '/login';
        } catch (error) {
          console.error(error);
          showAlert('Có lỗi xảy ra khi đổi mật khẩu.');
        }
      });
    </script>
  </body>
</html>
