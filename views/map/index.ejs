<!-- filepath: d:\Freelancer\tailwind_with_ejs_starter_template-master\views\admin\index.ejs -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include("../partials/head", { title: "T·ªïng quan" }) %>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
      rel="stylesheet"
    />
  </head>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .mapboxgl-canvas {
      width: 100% !important;
    }
    .map-container {
      position: relative;
      height: 78vh;
      flex: 1;
      border: 1px solid #7e22ce;
      /* Vi·ªÅn xanh */
      border-radius: 10px;
      /* Bo g√≥c */
      overflow: hidden;
      margin: 20px auto;
    }

    .bottom-button1 {
      cursor: pointer;
      position: absolute;
      right: 70px;
      bottom: 150px;
      padding: 8px;
      border-radius: 50%;
      background-color: aliceblue;
      border: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .bottom-button {
      margin: 5px;
      padding: 10px;
      cursor: pointer;
      position: absolute;
      left: 1000px;
      bottom: 10px;
    }

    .bottom-button2 {
      cursor: pointer;
      position: absolute;
      right: 70px;
      bottom: 100px;
      padding: 8px;
      border-radius: 50%;
      background-color: aliceblue;
      border: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    @media (max-width: 768px) {
      .bottom-button1 {
        right: 20px;
        bottom: 100px;
      }

      .bottom-button2 {
        right: 20px;
        bottom: 50px;
      }
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .map-title {
      position: absolute;
      top: 70px;
      left: 55%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 18px;
      font-weight: bold;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background: white;
      padding: 20px;
      margin: 10% auto;
      max-width: 500px;
      text-align: center;
      border-radius: 10px;
    }

    .close {
      float: right;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
  <body>
    <%- include('../partials/layout', {user:user,body: `
    <main>
      ${user.role === 'admin' ? `
      <nav
        class="flex items-center text-sm text-gray-500"
        aria-label="Breadcrumb"
      >
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
          <li aria-current="page">
            <div class="flex items-center">
              <i class="fas fa-house mr-2 text-gray-400"></i>
              <span class="text-gray-500">B·∫£n ƒë·ªì</span>
            </div>
          </li>
        </ol>
      </nav>
      ` : ''}
      <div class="map-container">
        <div id="map"></div>
        <button
          class="bottom-button1"
          onclick="centerOnUser()"
          title="V·ªã tr√≠ hi·ªán t·∫°i"
        >
          <i
            class="fa-solid fa-location-crosshairs"
            style="font-size: 25px; color: black"
          ></i>
        </button>
        <button
          class="bottom-button2"
          onclick="openFamilyModal()"
          title="Danh s√°ch v·ªã tr√≠ ng∆∞·ªùi th√¢n"
        >
          <i class="fas fa-users" style="font-size: 20px; color: black"></i>
        </button>
      </div>
      <div id="familyModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <h4 style="text-align: left">Danh s√°ch v·ªã tr√≠ ng∆∞·ªùi th√¢n</h4>
          <ul
            style="
              list-style-type: none;
              padding: 0;
              max-height: 50vh;
              overflow-y: auto;
            "
          >
            ${devices.map((location, index) => `
            <li
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                justify-content: flex-start;
              "
            >
              <label
                for="familyLocation_${index}"
                style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  cursor: pointer;
                "
              >
                <input type="radio" id="familyLocation_${index}"
                name="familyLocation" value="${index}" style="cursor: pointer"
                ${index === 0 ? 'checked' : ''} />
                <span style="cursor: pointer; margin-top: 8px">
                  ${location.name}
                </span>
                <span style="cursor: pointer" class="text-orange-500">
                  (${location.nickname})
                </span>
              </label>
            </li>
            `).join('')}
          </ul>
          <div
            style="
              display: flex;
              gap: 10px;
              justify-content: end;
              padding-top: 20px;
            "
          >
            <button
              onclick="confirmSelection('VIEW_GG_MAP')"
              class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-300"
            >
              Xem Google Maps
            </button>

            <button
              onclick="confirmSelection('VIEW')"
              class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-300"
            >
              Xem V·ªã Tr√≠
            </button>
          </div>
        </div>
      </div>
    </main>
    ` }) %>

    <script>
      // Nh·∫≠n th√¥ng tin user t·ª´ server
      const user = <%- JSON.stringify(user) %>;
      let devices = <%- JSON.stringify(devices) %>;
      let selectedUser;
      // C·∫•u h√¨nh Firebase
      const firebaseConfig = {
        apiKey: 'AIzaSyCrEO87Ue97VZ8SiBcHc0OrB3Fd1Nk3Z7I',
        authDomain: 'test-7b6bf.firebaseapp.com',
        databaseURL: 'https://test-7b6bf-default-rtdb.asia-southeast1.firebasedatabase.app',
        projectId: 'test-7b6bf',
        storageBucket: 'test-7b6bf.appspot.com',
        messagingSenderId: '95910027319',
        appId: '1:95910027319:web:fd855be4461803d19cdfb2',
        measurementId: 'G-1DGQ7162M7',
      };

      // Kh·ªüi t·∫°o Firebase (ch·ªâ khi ch∆∞a c√≥ app n√†o)
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      // Kh·ªüi t·∫°o b·∫£n ƒë·ªì Goong
      goongjs.accessToken = 'CIQMOscN4mBEjuaQZLXRZUxvdrvnOTZekkFsUyY3';
      const directionsAPIKey = '8mPFULcVLFwRdxuYQrBnLtgRnh3DctUXF11BVVuU';

      let map;
      let currentLocation;
      let destinationLocation = null;

      const center = [105.8342, 22.0278]; // H√† N·ªôi
      map = new goongjs.Map({
        container: 'map',
        style: 'https://tiles.goong.io/assets/goong_map_web.json',
        center,
        zoom: 1.5,
      });

      document.addEventListener('DOMContentLoaded', () => {
        // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa ng∆∞·ªùi d√πng
        navigator.geolocation.getCurrentPosition(
          (position) => {
            currentLocation = [position.coords.longitude, position.coords.latitude];
            map.flyTo({ center: currentLocation, zoom: 5 });

            // ƒê·∫∑t marker ng∆∞·ªùi d√πng
            new goongjs.Marker({ color: 'red', scale: 1.5 })
              .setLngLat(currentLocation)
              .addTo(map);
          },
          () => {
            toastr.warning('Vui l√≤ng chia s·∫ª v·ªã tr√≠ c·ªßa b·∫°n!', 'C·∫£nh b√°o', {
              closeButton: true,
              progressBar: true,
              positionClass: 'toast-top-right',
              timeOut: 3000,
            });
          }
        );

        // Qu·∫£n l√Ω marker ng∆∞·ªùi th√¢n
        const markersMap = {};
        const database = firebase.database();
        const ref = database.ref("/");
        const previousConnections = {};

        ref.on("value", (snapshot) => {
          const locations = snapshot.val();
          if (!locations) return;

          const currentKeys = new Set(Object.keys(locations));

          // Xo√° c√°c marker c≈© kh√¥ng c√≤n t·ªìn t·∫°i
          for (const key in markersMap) {
            if (!currentKeys.has(key)) {
              markersMap[key].remove();
              delete markersMap[key];
            }
          }

          // Th√™m ho·∫∑c c·∫≠p nh·∫≠t marker m·ªõi
          Object.entries(locations).forEach(([key, location]) => {


            const randomColor = getRandomColor();

            const notExist = !location?.latitude || !location?.longitude;
            const isConnected = location?.isConnected || false;


            const previous = previousConnections[key];

            if (previous !== undefined && previous !== isConnected) {
              const message = isConnected
                ? `Ng∆∞·ªùi th√¢n ${location.name} ƒë√£ **k·∫øt n·ªëi l·∫°i**!`
                : `Ng∆∞·ªùi th√¢n ${location.name} ƒë√£ **ng·∫Øt k·∫øt n·ªëi**!`;
              console.log("üöÄ ~ Object.entries ~ message:", message)

              const type = isConnected ? 'success' : 'warning';

              toastr[type](message, 'Th√¥ng b√°o', {
                  closeButton: true,
                  progressBar: true,
                  positionClass: 'toast-top-right',
                  timeOut: 3000,
                });
            }
            previousConnections[key] = isConnected;


            const lat = convertDDMMtoDD(location?.latitude || getRandomLatitudeDDMM());
            const lng = convertDDMMtoDD(location?.longitude || getRandomLongitudeDDMM());
            if(!devices?.find(device => device.code === key)) return;
            else{
              devices = devices.map(device => {
                if(device.code === key) {
                  device.latitude = lat;
                  device.longitude = lng;
                }
                return device;
              });

            }

            let nickname=devices?.find(device => device.code === key)?.nickname || ''

            if (markersMap[key]) {
              // C·∫≠p nh·∫≠t v·ªã tr√≠ v√† popup
              markersMap[key]
                .setLngLat([lng, lat])
                .setPopup(
                  new goongjs.Popup({ offset: 25 }).setHTML(`
                    <div class="flex flex-col gap-2 pr-5">
                     <p class="inline-block px-2 py-1 rounded text-xs font-semibold
                       ${isConnected ? 'bg-green-100 text-green-700 border border-green-300'
                                     : 'bg-gray-100 text-gray-700 border border-gray-300'}">
                       ${isConnected ? 'ƒêang k·∫øt n·ªëi' : 'M·∫•t k·∫øt n·ªëi'}
                     </p>
                     <h4  class="text-orange-300">${nickname}</h4>
                    <h4>${location.name}</h4>

                   </div>
                   ${
                    notExist
                        ? `<p style="color: red;">Kh√¥ng c√≥ v·ªã tr√≠</p>`
                        : `<p style="color: green;">Vƒ© ƒë·ªô: ${lat.toFixed(6)}<br>Kinh ƒë·ªô: ${lng.toFixed(6)}</p>
                          <button onclick="copyToClipboard('${lat.toFixed(6)}, ${lng.toFixed(6)}')" class="p-1 mt-4">Sao ch√©p t·ªça ƒë·ªô</button>`
                    }
                  `)
                );
            } else {
              // T·∫°o marker m·ªõi
              const marker = new goongjs.Marker({ color: randomColor, scale: 1.5 })
                .setLngLat([lng, lat])
                .setPopup(
                  new goongjs.Popup({ offset: 25 }).setHTML(`
                  <div class="flex flex-col gap-1 pr-5">
                     <p class="inline-block px-2 py-1 rounded text-xs font-semibold
                       ${isConnected ? 'bg-green-100 text-green-700 border border-green-300'
                                     : 'bg-gray-100 text-gray-700 border border-gray-300'}">
                       ${isConnected ? 'ƒêang k·∫øt n·ªëi' : 'M·∫•t k·∫øt n·ªëi'}
                     </p>
                     <span  class="text-orange-500">${nickname}</span>
                    <h4>${location.name}</h4>

                   </div>

                  ${
                    notExist
                        ? `<p style="color: red;">Kh√¥ng c√≥ v·ªã tr√≠</p>`
                        : `<p style="color: green;">Vƒ© ƒë·ªô: ${lat.toFixed(6)}<br>Kinh ƒë·ªô: ${lng.toFixed(6)}</p>
                          <button onclick="copyToClipboard('${lat.toFixed(6)}, ${lng.toFixed(6)}')" class="p-1 mt-4">Sao ch√©p t·ªça ƒë·ªô</button>`
                    }
                  `)
                )
                .addTo(map);

              markersMap[key] = marker;
            }

            // if(selectedUser)
            //   drawRoute(currentLocation, [lng.toFixed(6), lat.toFixed(6)]);
            if (selectedUser && selectedUser.code === key) {

              const newDestination = [lng, lat];
              if (
                !destinationLocation ||
                destinationLocation[0] !== newDestination[0] ||
                destinationLocation[1] !== newDestination[1]
              ) {
                destinationLocation = newDestination;
                drawRoute(currentLocation, destinationLocation);
              }
            }

          });

            devices=devices.filter(device => device.latitude && device.longitude)


        }, (error) => {
          console.error("L·ªói khi l·∫Øng nghe d·ªØ li·ªáu:", error);
        });
      });

      // ===========================
      // === H√†m ti·ªán √≠ch ========
      // ===========================

      function getRandomLatitudeDDMM() {
        const degrees = getRandomInt(8, 23); // 8¬∞N ƒë·∫øn 23¬∞N
        const minutes = Math.random() * 60;
        return parseFloat((degrees * 100 + minutes).toFixed(4));
      }

      function getRandomLongitudeDDMM() {
        const degrees = getRandomInt(102, 110); // 102¬∞E ƒë·∫øn 110¬∞E
        const minutes = Math.random() * 60;
        return parseFloat((degrees * 100 + minutes).toFixed(4));
      }

      function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }



      function convertDDMMtoDD(ddmm) {
        const degrees = Math.floor(ddmm / 100);
        const minutes = ddmm % 100;
        return degrees + minutes / 60;
      }

      function getRandomColor() {
        let color;
        do {
          color = `#${Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0')}`;
        } while (isRed(color));
        return color;
      }

      function isRed(hex) {
        const r = parseInt(hex.substring(1, 3), 16);
        const g = parseInt(hex.substring(3, 5), 16);
        const b = parseInt(hex.substring(5, 7), 16);
        return r > 180 && g < 100 && b < 100;
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          alert('ƒê√£ sao ch√©p: ' + text);
        });
      }

      function centerOnUser() {
        if (currentLocation) {

          map.flyTo({ center: currentLocation, zoom: 18 });
        } else {
          toastr.info('Ch∆∞a c√≥ v·ªã tr√≠ hi·ªán t·∫°i!');
        }
      }

      function centerOnDestination(location) {
        if (location) {
          destinationLocation = [location.longitude, location.latitude];
          map.flyTo({ center: destinationLocation, zoom: 18 });
          drawRoute(currentLocation, destinationLocation);
        }
      }

      function openGoogleMaps(location) {
        if (location.longitude && location.latitude) {
          window.open(
            `https://www.google.com/maps/dir/?api=1&destination=${location.latitude},${location.longitude}`,
            '_blank'
          );
        } else {
          toastr.info('B·∫°n ch∆∞a ch·ªçn v·ªã tr√≠ n√†o!');
        }
      }

      function openFamilyModal() {
        document.getElementById('familyModal').style.display = 'block';
      }

      function closeModal() {
        document.getElementById('familyModal').style.display = 'none';
      }

      function confirmSelection(type) {
        const selected = document.querySelector('input[name="familyLocation"]:checked');


        if (selected) {
           selectedUser = devices[selected.value];

          closeModal();

          if (type === 'VIEW') {
            centerOnDestination(selectedUser);
          } else if (type === 'VIEW_GG_MAP') {
            openGoogleMaps(selectedUser);
          } else {
            alert("Vui l√≤ng ch·ªçn m·ªôt h√†nh ƒë·ªông h·ª£p l·ªá!");
          }
        } else {
          alert("Vui l√≤ng ch·ªçn m·ªôt ng∆∞·ªùi th√¢n!");
        }
      }

      // ===========================
      // === V·∫Ω tuy·∫øn ƒë∆∞·ªùng =======
      // ===========================

      async function drawRoute(start, end) {
        if (!start || !end) return;

        const url = `https://rsapi.goong.io/Direction?origin=${start[1]},${start[0]}&destination=${end[1]},${end[0]}&vehicle=car&api_key=${directionsAPIKey}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
          const points = data.routes[0].overview_polyline.points;
          const coordinates = decodePolyline(points);

          const geoJsonData = {
            type: 'Feature',
            geometry: { type: 'LineString', coordinates },
          };

          if (map.getSource('route')) {
            map.getSource('route').setData(geoJsonData);
          } else {
            map.addSource('route', {
              type: 'geojson',
              data: geoJsonData,
            });

            map.addLayer({
              id: 'route',
              type: 'line',
              source: 'route',
              layout: { 'line-join': 'round', 'line-cap': 'round' },
              paint: { 'line-color': '#3887be', 'line-width': 5 },
            });
          }
        } else {
          console.error('‚ö† Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng.');
        }
      }

      function decodePolyline(polyline) {
        let index = 0,
          lat = 0,
          lng = 0,
          coordinates = [];

        while (index < polyline.length) {
          let shift = 0, result = 0, byte;
          do {
            byte = polyline.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
          } while (byte >= 0x20);
          lat += result & 1 ? ~(result >> 1) : result >> 1;

          shift = result = 0;
          do {
            byte = polyline.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
          } while (byte >= 0x20);
          lng += result & 1 ? ~(result >> 1) : result >> 1;

          coordinates.push([lng / 1e5, lat / 1e5]);
        }
        return coordinates;

      }
    </script>

    <!-- Toastr JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  </body>
</html>
