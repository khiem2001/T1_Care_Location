<%- include("../partials/head", { title: "Chọn thiết bị" }) %>

<body>
  <%- include('../partials/layout', { user: user, body: `
  <main class="p-6 max-w-4xl mx-auto">
    <!-- Filter options -->
    <div class="flex gap-4 mb-4">
      <label class="flex items-center gap-2 text-purple-700">
        <input type="radio" name="filter" value="unfollowed" ${status ===
        'unfollowed' ? 'checked' : ''} /> Thiết bị chưa theo dõi
      </label>
      <label class="flex items-center gap-2 text-purple-700">
        <input type="radio" name="filter" value="followed" ${status ===
        'followed' ? 'checked' : ''} /> Thiết bị đang theo dõi
      </label>
    </div>

    <!-- Action radio for unfollowed devices -->
    <!-- ${status === 'unfollowed' ? `
    <div class="mb-4">
      <label class="flex items-center gap-2 text-purple-700">
        <input
          type="radio"
          name="action"
          value="secret"
          id="enterSecret"
          checked
        />
        Nhập mã bí mật để theo dõi
      </label>
      <label class="flex items-center gap-2 text-purple-700">
        <input type="radio" name="action" value="request" id="requestFollow" />
        Gửi yêu cầu theo dõi
      </label>
    </div>
    ` : ''} -->

    <!-- Search box -->
    <input
      type="text"
      id="search"
      placeholder="Tìm thiết bị..."
      class="w-full p-2 border border-purple-300 rounded mb-4 focus:ring-purple-500 focus:border-purple-500"
    />

    <!-- Device list -->
    <form id="deviceForm" action="/devices" method="POST">
      <!-- Submit button (toggle visibility) -->
      <!-- ${status === 'unfollowed' ? `
      <button
        id="submitButton"
        type="submit"
        class="mb-4 px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 hidden"
      >
        Gửi yêu cầu theo dõi
      </button>
      ` : ''} -->

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        ${devices.map(device => `
        <label
          class="device-item border border-purple-300 p-4 rounded cursor-pointer flex justify-between items-start hover:bg-purple-100"
          data-following="${device.isFollowing}"
        >
          ${status === 'followed' ? `
          <div class="flex flex-col gap-2 w-full">
            <span class="text-purple-700 font-semibold">
              ${device.name} (${device.code})
            </span>
            <span class="text-blue-700 nickname-text"
              >${device?.nickname || '__'}</span
            >
            <input
              type="text"
              name="nickname"
              value="${device?.nickname || ''}"
              class="nickname-input hidden p-1 border border-blue-300 rounded"
              data-device-id="${device._id}"
            />
          </div>
          <div class="flex flex-col gap-2">
            <button
              type="button"
              class="edit-btn text-yellow-600 hover:text-yellow-800"
              title="Chỉnh sửa"
              data-device-id="${device._id}"
            >
              <i class="fas fa-edit"></i>
            </button>
            <button
              type="button"
              class="save-btn text-green-600 hover:text-green-800 hidden"
              title="Lưu"
              data-device-id="${device._id}"
            >
              <i class="fas fa-check"></i>
            </button>
          </div>
          ` : `
          <div class="flex flex-col gap-2 w-full">
            <div class="flex items-center gap-2">
              <!-- <input type="checkbox" name="deviceIds" value="${device._id}"
              class="form-checkbox h-5 w-5 text-purple-500 request-checkbox"
              ${device.isFollowing ? 'disabled' : ''} /> -->
              <span class="text-purple-700"
                >${device.name} (${device.code})</span
              >
            </div>
            <div class="flex items-center gap-2 mt-2">
              <input
                type="text"
                name="secretKey_${device._id}"
                class="secretKey-input p-2 border border-blue-300 rounded w-full"
                placeholder="Nhập mã bí mật"
                data-device-id="${device._id}"
              />
              <button
                type="button"
                class="send-secret-btn text-green-600 hover:text-green-800"
                data-device-id="${device._id}"
                title="Gửi mã"
              >
                <i class="fas fa-check"></i>
              </button>
            </div>
          </div>
          `}
        </label>
        `).join('')}
      </div>
    </form>
  </main>
  ` }) %>
</body>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    // Search filter
    $('#search').on('input', function () {
      const keyword = $(this).val().toLowerCase();
      $('.device-item').each(function () {
        const text = $(this).text().toLowerCase();
        $(this).toggle(text.includes(keyword));
      });
    });

    // Filter by status (radio)
    $('input[name="filter"]').on('change', function () {
      const selectedStatus = $(this).val();
      const url = new URL(window.location.href);
      url.searchParams.set('status', selectedStatus);
      window.location.href = url.toString();
    });

    // Toggle action display
    $('input[name="action"]').on('change', function () {
      const selected = $('input[name="action"]:checked').val();
      if (selected === 'request') {
        $('.request-checkbox').removeClass('hidden');
        $('.secretKey-input, .send-secret-btn').addClass('hidden');

        // Show submit button only if checkbox checked
        const isChecked = $('.request-checkbox:checked').length > 0;
        $('#submitButton').toggleClass('hidden', !isChecked);
      } else {
        $('.request-checkbox').addClass('hidden');
        $('.secretKey-input, .send-secret-btn').removeClass('hidden');
        $('#submitButton').addClass('hidden');
      }
    });

    // Toggle submit button visibility
    $(document).on('change', '.request-checkbox', function () {
      const isChecked = $('.request-checkbox:checked').length > 0;
      $('#submitButton').toggleClass('hidden', !isChecked);
    });

    // Nickname edit
    $('.edit-btn').on('click', function () {
      const label = $(this).closest('.device-item');
      label.find('.nickname-text').addClass('hidden');
      label.find('.nickname-input').removeClass('hidden').focus();
      label.find('.save-btn').removeClass('hidden');
      $(this).addClass('hidden');
    });

    // Nickname save
    $('.save-btn').on('click', async function () {
      const label = $(this).closest('.device-item');
      const input = label.find('.nickname-input');
      const nickname = input.val().trim();
      const deviceId = input.data('device-id');

      const res = await fetch('/devices/update-nickname', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ deviceId, nickname }),
      });

      const data = await res.json();

      if (res.ok) {
        label.find('.nickname-text').text(nickname).removeClass('hidden');
        input.addClass('hidden');
        $(this).addClass('hidden');
        label.find('.edit-btn').removeClass('hidden');
      } else {
        alert(data.message || 'Lỗi khi cập nhật nickname!');
      }
    });

    // Send secret key
    $('.send-secret-btn').on('click', async function () {
      const deviceId = $(this).data('device-id');
      const secretKey = $(`input[name="secretKey_${deviceId}"]`).val().trim();

      const res = await fetch('/devices/secretKey', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ deviceId, secretKey }),
      });

      const data = await res.json();

      if (data.success == true) {
        window.location.reload();
      } else {
        alert(data.message || 'Gửi thất bại!');
      }
    });

    // Trigger action display on load
    $('input[name="action"]:checked').trigger('change');
  });
</script>
