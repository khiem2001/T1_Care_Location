<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include("../../partials/head", { title: "Thiết bị" }) %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <%- include('../../partials/layout', { body: `
    <main class="bg-white p-6 rounded-lg shadow-lg">
      <!-- Breadcrumb -->
      <nav
        class="flex items-center text-sm text-gray-500 mb-6"
        aria-label="Breadcrumb"
      >
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
          <li aria-current="page">
            <div class="flex items-center">
              <i class="fas fa-house mr-2 text-gray-400"></i>
              <span class="text-gray-500">Danh sách thiết bị</span>
            </div>
          </li>
        </ol>
      </nav>

      <!-- Filter Form -->
      <div>
        <form
          method="GET"
          action="/devices-management"
          id="filterForm"
          class="mb-6"
        >
          <div class="flex flex-col md:flex-row gap-4 mb-3">
            <div class="w-full md:w-1/3">
              <input
                type="text"
                name="search"
                id="searchInput"
                class="w-full p-3 border border-gray-300 rounded-md"
                placeholder="Tìm kiếm theo mã hoặc tên"
                value="${search || ''}"
              />
            </div>
            <div class="w-full md:w-1/4">
              <button
                type="submit"
                class="w-1/3 p-3 bg-[#7E22CE] text-white rounded-md hover:bg-purple-700 transition"
              >
                Tìm kiếm
              </button>
            </div>
          </div>
        </form>

        <!-- User Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto bg-white shadow-md rounded-lg">
            <thead class="bg-[#9B4DFF] text-white">
              <tr>
                <th class="px-4 py-2 text-left">ID</th>
                <th class="px-4 py-2 text-left">Họ & Tên</th>
                <th class="px-4 py-2 text-left">Mã bí mật</th>
                <th class="px-4 py-2 text-center">Hành động</th>
              </tr>
            </thead>
            <tbody>
              ${devices.map(device => `
              <!-- Hàng chính -->
              <tr class="border-b device-row" data-code="${device.code}">
                <td class="px-4 py-2">
                  <button
                    class="toggle-row text-gray-500 hover:text-purple-700 mr-2"
                  >
                    <i class="fas fa-chevron-down"></i>
                  </button>
                  ${device.code}
                </td>
                <td class="px-4 py-2 name-cell">${device.name || ''}</td>
                <td class="px-4 py-2 secretKey-cell">
                  ${device.secretKey || ''}
                  <button
                    class="copy-btn text-blue-500 hover:text-blue-700 transition ml-2"
                    data-secretkey="${device.secretKey || ''}"
                    title="Sao chép mã bí mật"
                  >
                    <i class="fas fa-copy"></i>
                  </button>
                </td>
                <td class="px-4 py-2 text-center">
                  <button
                    class="edit-btn text-blue-500 hover:text-blue-700 transition"
                    data-id="${device.code}"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                </td>
              </tr>

              <!-- Hàng mở rộng -->
              <tr
                class="hidden extra-info bg-gray-50"
                data-code="${device.code}"
              >
                <td colspan="4" class="p-4">
                  <div>
                    <h4 class="font-semibold mb-2 text-sm text-purple-700">
                      Người dùng đã kết nối:
                    </h4>
                    <ul class="list-disc pl-5 text-sm text-gray-700">
                      ${(device.users && device.users.length > 0) ?
                      device.users.map(user => `
                      <li>
                        <span> ${user.full_name} ${user.email}</span>
                        <button
                          class="ml-4 text-red-500 hover:text-red-700 delete-device"
                          title="Xóa thiết bị"
                          data-code="${device.code}_${user._id}"
                        >
                          <i class="fas fa-trash-alt text-xl"></i>
                        </button>
                      </li>
                      `).join('') : `
                      <li>Không có người dùng</li>
                      ` }
                    </ul>
                  </div>
                </td>
              </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div
          class="mt-10 flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <p class="text-sm text-gray-600">
            Tổng:
            <span class="font-semibold text-[#a66add]">${totalDevices}</span>
            thiết bị
          </p>

          <nav>
            <ul class="inline-flex items-center space-x-2 text-sm">
              <li>
                <a
                  href="/devices-management?page=${currentPage > 1 ? currentPage - 1 : 1}&search=${search || ''}"
                  class="px-2 py-1 border border-gray-300 rounded-l-md bg-white text-[#a66add] hover:bg-purple-100 transition"
                >
                  <i class="fas fa-chevron-left text-xs"></i>
                </a>
              </li>

              ${Array.from({ length: totalPages }, (_, i) => { const page = i +
              1; const isActive = currentPage === page; return `
              <li>
                <a
                  href="/devices-management?page=${page}&search=${search || ''}"
                  class="px-2 py-1 border border-gray-300 ${isActive ? 'bg-[#a66add] text-white' : 'bg-white text-[#a66add]'} hover:bg-purple-100 transition"
                >
                  ${page}
                </a>
              </li>
              `; }).join('')}

              <li>
                <a
                  href="/devices-management?page=${currentPage < totalPages ? currentPage + 1 : totalPages}&search=${search || ''}"
                  class="px-2 py-1 border border-gray-300 rounded-r-md bg-white text-[#a66add] hover:bg-purple-100 transition"
                >
                  <i class="fas fa-chevron-right text-xs"></i>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </main>
    ` }) %>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
      $(document).ready(function () {
        // Chức năng chỉnh sửa
        $('.edit-btn').click(function () {
          const $btn = $(this);
          const $row = $btn.closest('tr');
          const $nameCell = $row.find('.name-cell');
          const $secretKeyCell = $row.find('.secretKey-cell');

          const isEditing = $btn.data('editing');
          const deviceId = $btn.data('id'); // Assuming the button has a data-id attribute with the device ID

          if (isEditing) {
            // Save mode
            const newName = $nameCell.find('input').val();
            const newSecretKey = $secretKeyCell.find('input').val();

            // Call the API to update the name and secretKey
            $.ajax({
              url: `/devices-management/${deviceId}`,
              method: 'PUT',
              contentType: 'application/json',
              data: JSON.stringify({ name: newName, secretKey: newSecretKey }),
              success: function () {
                toastr.success('Cập nhật thành công!');
                $nameCell.text(newName);
                $secretKeyCell.text(newSecretKey);
                $btn.html('<i class="fas fa-edit"></i>');
                $btn.data('editing', false);
              },
              error: function () {
                toastr.error('Cập nhật thất bại.');
              },
            });
          } else {
            // Edit mode
            const currentName = $nameCell.text().trim();
            const currentSecretKey = $secretKeyCell.text().trim();

            $nameCell.html(
              '<input type="text" class="p-2 border border-gray-300 rounded-md w-full" value="' +
                currentName +
                '" />'
            );

            $secretKeyCell.html(
              '<input type="text" class="p-2 border border-gray-300 rounded-md w-full" value="' +
                currentSecretKey +
                '" />'
            );

            $btn.html('<i class="fas fa-check text-green-600"></i>');
            $btn.data('editing', true);
          }
        });

        // Chức năng sao chép mã bí mật
        $('.copy-btn').click(function () {
          const secretKey = $(this).data('secretkey');
          navigator.clipboard
            .writeText(secretKey)
            .then(function () {
              toastr.success('Mã bí mật đã được sao chép!');
            })
            .catch(function () {
              toastr.error('Lỗi khi sao chép mã bí mật.');
            });
        });
        $('.toggle-row').click(function () {
          const $btn = $(this);
          const $row = $btn.closest('tr');
          const code = $row.data('code');
          const $extraRow = $(`.extra-info[data-code="${code}"]`);

          $extraRow.toggleClass('hidden');

          const icon = $btn.find('i');
          icon.toggleClass('fa-chevron-down fa-chevron-up');
        });

        $('.delete-device').click(function () {
          const codeWithUserId = $(this).data('code'); // ví dụ: "D001_6456ef..."
          const [deviceCode, userId] = codeWithUserId.split('_');

          if (
            confirm(
              `Bạn có chắc muốn xóa người dùng khỏi thiết bị ${deviceCode}?`
            )
          ) {
            $.ajax({
              url: `/devices-management/${deviceCode}/users/${userId}`, // route cụ thể hóa
              method: 'DELETE',
              success: function () {
                toastr.success('Đã xóa người dùng khỏi thiết bị!');
                window.location.reload();
              },
              error: function () {
                toastr.error('Lỗi khi xóa người dùng khỏi thiết bị.');
              },
            });
          }
        });
      });
    </script>
  </body>
</html>
