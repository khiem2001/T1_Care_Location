<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include("../../partials/head", { title: "Y√™u c·∫ßu" }) %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <%- include('../../partials/layout', { body: `
    <main class="bg-white p-6 rounded-lg shadow-lg">
      <!-- Breadcrumb -->
      <nav
        class="flex items-center text-sm text-gray-500 mb-6"
        aria-label="Breadcrumb"
      >
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
          <li aria-current="page">
            <div class="flex items-center">
              <i class="fas fa-house mr-2 text-gray-400"></i>
              <span class="text-gray-500">Danh s√°ch y√™u c·∫ßu</span>
            </div>
          </li>
        </ol>
      </nav>

      ${userDevices.length === 0 ? `
      <p class="text-gray-600">Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·ªù duy·ªát.</p>
      ` : ` ${userDevices.map(({ user, devices }) => `
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-purple-600 mb-2">
          üë§ ${user.full_name} - ${user.email}
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
          ${devices.map(device => `
          <div
            class="border border-gray-200 rounded-lg p-4 shadow-sm bg-white flex flex-col justify-between"
          >
            <div>
              <p class="text-md font-medium text-gray-800">${device.name}</p>
              <p class="text-sm text-gray-500">M√£: ${device.code}</p>
            </div>
            <div class="flex space-x-2 mt-4">
              <button
                onclick="confirmAction('${user._id}', '${device._id}', 1)"
                class="flex-1 px-4 py-2 border border-purple-600 text-purple-600 rounded hover:bg-purple-600 hover:text-white transition"
              >
                Duy·ªát
              </button>
              <button
                onclick="confirmAction('${user._id}', '${device._id}', 0)"
                class="flex-1 px-4 py-2 border border-red-500 text-red-500 rounded hover:bg-red-500 hover:text-white transition"
              >
                T·ª´ ch·ªëi
              </button>
            </div>
          </div>
          `).join('')}
        </div>
      </div>
      `).join('')} `}
    </main>

    <!-- Modal x√°c nh·∫≠n -->
    <div
      id="confirmModal"
      class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-80">
        <p class="text-gray-800 text-md mb-4">
          B·∫°n c√≥ ch·∫Øc ch·∫Øn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?
        </p>
        <div class="flex justify-end space-x-2">
          <button
            onclick="closeModal()"
            class="px-4 py-2 text-gray-600 hover:text-black"
          >
            H·ªßy
          </button>
          <button
            id="confirmBtn"
            class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700"
          >
            X√°c nh·∫≠n
          </button>
        </div>
      </div>
    </div>

    <script>
      let pendingAction = null;

      function confirmAction(userId, deviceId, status) {
        pendingAction = { userId, deviceId, status };
        document.getElementById('confirmModal').classList.remove('hidden');
      }

      function closeModal() {
        pendingAction = null;
        document.getElementById('confirmModal').classList.add('hidden');
      }

      document
        .getElementById('confirmBtn')
        .addEventListener('click', async () => {
          if (!pendingAction) return;

          try {
            const res = await fetch('/requests', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(pendingAction),
            });

            const data = await res.json();
            if (res.ok) {
              alert(data.message);
              location.reload(); // reload l·∫°i danh s√°ch
            } else {
              alert(data.message || 'ƒê√£ c√≥ l·ªói x·∫£y ra!');
            }
          } catch (err) {
            alert('L·ªói k·∫øt n·ªëi ƒë·∫øn server.');
          } finally {
            closeModal();
          }
        });
    </script>
    ` }) %>
  </body>
</html>
